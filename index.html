<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explora tu vocaci√≥n profesional con IA - Expo Carreras 2026</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #app-container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            width: 100%;
            max-width: 768px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 70vh; /* Minimum height for the app */
            position: relative; /* Needed for absolute positioning of splash screen */
        }
        #splash-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* Match app background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10; /* Ensure it's above chat content */
            transition: opacity 0.5s ease-out; /* Smooth fade-out */
            opacity: 1;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }
        #splash-screen img {
            max-width: 60%; /* Adjusted from 80% */
            max-height: 50%; /* Added max-height for better control */
            height: auto;
            border-radius: 0.75rem; /* Rounded corners for image */
            margin-bottom: 1.5rem;
        }
        #splash-screen h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Gray-900 */
            text-align: center;
            padding: 0 1rem;
        }
        #chat-content {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure chat content fills container */
            opacity: 0; /* Hidden initially */
            transition: opacity 0.5s ease-in; /* Smooth fade-in */
        }
        #chat-content.visible {
            opacity: 1;
        }
        #chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #f9fafb; /* Slightly off-white for chat background */
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; /* Rounded message bubbles */
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #3b82f6; /* Blue for user messages */
            color: white;
            border-bottom-right-radius: 0.25rem; /* Slightly less rounded on the bottom right */
        }
        .bot-message {
            align-self: flex-start;
            background-color: #e5e7eb; /* Light gray for bot messages */
            color: #374151; /* Darker text for readability */
            border-bottom-left-radius: 0.25rem; /* Slightly less rounded on the bottom left */
        }
        #input-area {
            display: flex;
            flex-direction: column; /* Allow buttons to stack above input */
            padding: 1rem;
            border-top: 1px solid #e5e7eb; /* Separator line */
            background-color: #ffffff;
        }
        #text-input-container {
            display: flex;
            width: 100%;
        }
        #user-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        #user-input:focus {
            border-color: #3b82f6;
        }
        #send-button {
            margin-left: 0.75rem;
            padding: 0.75rem 1.25rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }
        #send-button:hover {
            background-color: #2563eb;
        }
        #send-button:active {
            transform: scale(0.98);
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        .loading-indicator.active {
            display: block;
        }
        /* Markdown styling within messages */
        .message-bubble strong {
            font-weight: 700;
        }
        .message-bubble ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            padding-left: 0;
        }
        .message-bubble ol {
            list-style-type: decimal;
            margin-left: 1.25rem;
            padding-left: 0;
        }
        .message-bubble li {
            margin-bottom: 0.25rem;
        }
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .message-bubble h1 { font-size: 1.5em; }
        .message-bubble h2 { font-size: 1.25em; }
        .message-bubble h3 { font-size: 1.1em; }

        /* Confirmation buttons styling */
        #confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem; /* Space between buttons and text input */
            display: none; /* Hidden by default */
        }
        .confirm-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #yes-button {
            background-color: #22c55e; /* Green for Yes */
            color: white;
            border: none;
        }
        #yes-button:hover {
            background-color: #16a34a;
        }
        #no-button {
            background-color: #ef4444; /* Red for No */
            color: white;
            border: none;
        }
        #no-button:hover {
            background-color: #dc2626;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-container {
                min-height: 90vh;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="flex flex-col items-center justify-center p-4">
            <img src="https://juanpaneveu.com.ar/img/tu-futuro-en-la-pampa.jpg" alt="Imagen de fondo de La Pampa con estudiantes y elementos tecnol√≥gicos">
            <h1 class="text-3xl font-bold text-gray-900 text-center">¬øPuede la IA ayudarte a encontrar tu vocaci√≥n? Descubrilo.</h1>
        </div>

        <!-- Main Chat Content (initially hidden) -->
        <div id="chat-content" class="flex flex-col h-full">
            <div id="chat-messages">
                <!-- Messages will be appended here -->
            </div>
            <div class="loading-indicator" id="loading-indicator">Cargando respuesta...</div>
            <div id="input-area">
                <div id="confirmation-buttons">
                    <button id="yes-button" class="confirm-button">S√≠</button>
                    <button id="no-button" class="confirm-button">No</button>
                </div>
                <div id="text-input-container">
                    <input type="text" id="user-input" placeholder="Escrib√≠ tu mensaje aqu√≠..." autocomplete="off">
                    <button id="send-button">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Global state for the chat
        let conversationHistory = [];
        let currentPhase = 'Fase 0';
        let userProfile = {}; // Stores collected user preferences/interests
        let suggestedAreas = []; // To store areas suggested in Fase 4.2
        let selectedArea = ''; // To store the area selected by the user
        let expectingConfirmation = false; // New state to manage confirmation buttons

        // Variables para el manejo de reintentos en la llamada inicial
        const MAX_INITIAL_RETRIES = 2; // N√∫mero m√°ximo de reintentos para la llamada inicial
        const RETRY_DELAY_MS = 1500; // Retraso en milisegundos entre reintentos

        // Constants for emojis
        const EMOJI_WELCOME = 'üëã';
        const EMOJI_GUIDE_QUESTION = 'üß≠';
        const EMOJI_IDEA_SUGGESTION = 'üí°';
        const EMOJI_ACADEMIC_INFO = 'üéì';
        const EMOJI_SUMMARY_CONFIRMATION = '‚úÖ';
        const EMOJI_REFLECTION = 'ü§î';
        const EMOJI_PROFESSIONAL_CLARIFICATION = '‚öñÔ∏è';
        const EMOJI_RESET = 'üîÑ';

        // UI Elements
        const splashScreen = document.getElementById('splash-screen');
        const chatContent = document.getElementById('chat-content');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const confirmationButtonsDiv = document.getElementById('confirmation-buttons');
        const yesButton = document.getElementById('yes-button');
        const noButton = document.getElementById('no-button');
        const textInputContainer = document.getElementById('text-input-container');


        // Function to display messages in the chat interface
        const displayMessage = (message, sender) => {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            if (sender === 'user') {
                messageBubble.classList.add('user-message');
            } else {
                messageBubble.classList.add('bot-message');
            }

            // Simple Markdown parsing for bold text (**)
            // This replaces **text** with <strong>text</strong>
            let parsedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Parse unordered list items (- Item)
            // This regex also handles nested unordered lists (e.g., "  - Sub-item")
            parsedMessage = parsedMessage.replace(/^( *)[*-] (.*)$/gm, (match, spaces, content) => {
                const indentLevel = spaces.length / 2; // Assuming 2 spaces per indent level
                return `<li style="margin-left: ${indentLevel * 1.5}rem;">${content}</li>`;
            });

            // Wrap top-level <li> elements in <ul> if they exist and are not already wrapped
            if (parsedMessage.includes('<li>') && !parsedMessage.includes('<ul>') && !parsedMessage.includes('<ol>')) {
                parsedMessage = `<ul>${parsedMessage}</ul>`;
            }

            // Parse ordered list items (1. Item)
            // This regex captures lines starting with a number followed by a dot and a space
            let orderedListHtml = '';
            const orderedListItems = parsedMessage.match(/^\d+\. (.*)$/gm);
            if (orderedListItems) {
                orderedListHtml = '<ol>';
                orderedListItems.forEach(item => {
                    orderedListHtml += `<li>${item.replace(/^\d+\. /, '')}</li>`;
                });
                orderedListHtml += '</ol>';
                // Replace the original markdown list with the HTML list
                parsedMessage = parsedMessage.replace(/^\d+\. (.*)$/gm, '').trim(); // Remove original markdown list lines
                parsedMessage += orderedListHtml; // Append the new HTML ordered list
            }

            // Parse Markdown links [text](url)
            parsedMessage = parsedMessage.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:underline">$1</a>');


            messageBubble.innerHTML = parsedMessage; // Use innerHTML to render parsed Markdown
            chatMessagesDiv.appendChild(messageBubble);
            scrollToBottom();
        };

        // Function to scroll chat to the bottom
        const scrollToBottom = () => {
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        };

        // Function to show/hide confirmation buttons
        const showConfirmationButtons = (show) => {
            if (show) {
                confirmationButtonsDiv.style.display = 'flex';
                textInputContainer.style.display = 'none'; // Hide regular input
                expectingConfirmation = true;
            } else {
                confirmationButtonsDiv.style.display = 'none';
                textInputContainer.style.display = 'flex'; // Show regular input
                expectingConfirmation = false;
            }
        };

        // Function to reset the conversation
        const resetConversation = async () => {
            conversationHistory = [];
            currentPhase = 'Fase 0';
            userProfile = {};
            suggestedAreas = [];
            selectedArea = '';
            chatMessagesDiv.innerHTML = '';
            displayMessage(`${EMOJI_RESET} Reiniciando la conversaci√≥n...`, 'bot');
            showConfirmationButtons(false); // Hide buttons on reset
            // No llamar a getBotResponse aqu√≠, ya que el flujo inicial lo manejar√°
        };

        // Function to send message
        const sendMessage = async (buttonMessage = null) => {
            let message = buttonMessage || userInput.value.trim();
            if (message === '') return;

            displayMessage(message, 'user');
            conversationHistory.push({ text: message, sender: 'user' });
            userInput.value = '';
            sendButton.disabled = true; // Disable button while processing
            loadingIndicator.classList.add('active'); // Show loading indicator
            showConfirmationButtons(false); // Hide buttons after any message is sent

            // Check for reset command
            if (message.toLowerCase() === 'empezar de nuevo' || message.toLowerCase() === 'reset') {
                await resetConversation();
                sendButton.disabled = false;
                loadingIndicator.classList.remove('active');
                return;
            }

            // For user-initiated messages, always call getBotResponse without initialCall flags
            await getBotResponse(message);
        };

        // Helper function for delay
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // Function to get bot response from Vercel Serverless Function
        // This function now assumes it's a regular call, not the initial one with retries
        const getBotResponse = async (userMessage) => {
            // Check if running in a local file system or Canvas blob URL
            const isLocalOrCanvas = window.location.protocol === 'file:' || window.location.protocol === 'blob:';

            if (isLocalOrCanvas) {
                displayMessage("Disculp√°, la funcionalidad de IA requiere que la aplicaci√≥n est√© desplegada en un servidor (como Vercel) para funcionar. Por favor, despleg√° la aplicaci√≥n y asegurate de que la clave API est√© configurada en Vercel.", 'bot');
                return null; // Return null to indicate failure in Canvas
            }

            // Construct the prompt based on the current phase and user profile
            let prompt = `
            Eres **Explora tu vocaci√≥n con IA - Expo carreras 2026**, un asistente vocacional, dise√±ado para guiar a estudiantes de 5¬∫ y 6¬∫ a√±o de la secundaria en la provincia de La Pampa, Argentina. Tu misi√≥n es facilitar un proceso de autodiscovery y reflexi√≥n que conecte la identidad personal del estudiante con la exploraci√≥n de la oferta acad√©mica superior de manera accesible, clara y profesional. Eres una herramienta de apoyo para el primer paso de la orientaci√≥n, no un reemplazo de un orientador humano.

            Tu personalidad es la de un gu√≠a paciente, alentador, curioso y objetivo. La interacci√≥n debe sentirse como una conversaci√≥n estructurada pero natural, que genera confianza y seguridad.

            **Identidad Visual en el Texto:**
            Uso de Markdown: Emplea Markdown para jerarquizar y clarificar la informaci√≥n.
            Negrita: Usa negrita para resaltar conceptos clave, nombres de carreras o √°reas de conocimiento.
            **Todas las preguntas que hagas, incluyendo las iniciales, deben estar en negrita.**
            Listas con Vi√±etas: Utiliza listas (con * o -) para presentar opciones, res√∫menes y recomendaciones.
            Paleta de Emojis: Utiliza los siguientes emojis de forma sutil y consistente:
            üëã Bienvenida y Despedida
            üß≠ Gu√≠a y Preguntas
            üí° Ideas y Sugerencias
            üéì Informaci√≥n Acad√©mica
            ‚úÖ Res√∫menes y Confirmaciones
            ü§î Reflexi√≥n
            ‚öñÔ∏è Aclaraci√≥n Profesional
            üîÑ Reinicio

            **Claridad y Accesibilidad:**
            Lenguaje Sencillo: Evita la jerga acad√©mica. Si usas un t√©rmino como "tecnicatura" o "carrera de grado", explica brevemente la diferencia.
            Voseo Argentino: Utiliza siempre el "vos" de manera natural.
            Paciencia: Si una respuesta del usuario es ambigua ("no s√©", "quiz√°s"), responde con empat√≠a y reformula la pregunta desde otro √°ngulo.
            **Si en alg√∫n momento me pregunt√°s mi nombre, por favor, aclar√° que solo quer√©s el nombre, sin el apellido.**

            **Base de Conocimiento y Prioridades:**
            Tu conocimiento sobre oferta acad√©mica debe seguir este orden estricto:
            1.  **Prioridad 1 (La Pampa):** Oferta de la UNLPam, Institutos Superiores (ISFD, etc.), p√∫blicos y privados, en La Pampa. Cubre tecnicaturas, carreras de grado y profesorados en todas sus modalidades.
                **Cuando te refieras al Instituto Tecnol√≥gico de Educaci√≥n Superior de La Pampa, utiliza siempre el acr√≥nimo ITES.**
            2.  **Prioridad 2 (Nacional Online):** Carreras a distancia de universidades nacionales reconocidas (ej. UBA XXI, UNQ Virtual, UNL Virtual).
            3.  **Prioridad 3 (Otras Provincias):** Carreras presenciales en otras provincias, solo si el estudiante expresa expl√≠citamente su disposici√≥n a mudarse.

            **Flujo de Conversaci√≥n y L√≥gica de Interacci√≥n:**
            Tu directriz principal es un di√°logo paso a paso. Nunca hagas m√°s de una pregunta a la vez.
            **El bot puede permitir saltar preguntas o profundizar seg√∫n el inter√©s del usuario.**
            **Es deseable que el bot no etiquete prematuramente al estudiante (evitar "sos m√°s humanista" o "sos t√©cnico"), sino que devuelva insumos reflexivos.**

            **Contexto de la conversaci√≥n actual:**
            Fase actual: ${currentPhase}
            Perfil del estudiante (hasta ahora): ${JSON.stringify(userProfile, null, 2)}
            √Åreas sugeridas (si aplica): ${JSON.stringify(suggestedAreas)}
            √Årea seleccionada (si aplica): ${selectedArea}
            Mensaje del usuario: "${userMessage}"

            **Instrucciones para la pr√≥xima respuesta (basadas en la fase actual y el mensaje del usuario):**
            **Importante: Evita repetir la informaci√≥n que el estudiante acaba de mencionar, a menos que sea para un resumen expl√≠cito de confirmaci√≥n (Fase 3.1). S√© lo m√°s sint√©tico posible en tus respuestas.**

            `;

            // Append specific instructions based on the current phase
            switch (currentPhase) {
                case 'Fase 0':
                    prompt += `
                    **Paso 0.1:** ${EMOJI_WELCOME} Hola, soy **Explora tu vocaci√≥n, tu asistente virtual en la Expo Carreras 2026**.
                    Importante: Este asistente fue dise√±ado con Inteligencia Artificial (IA) para acompa√±arte en la exploraci√≥n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaci√≥n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexi√≥n, di√°logo y consulta humana.
                    **Pregunta:** **¬øQu√© actividades te entusiasman o te hacen perder la noci√≥n del tiempo cuando las hac√©s?**
                    `;
                    break;
                case 'Fase 1.1': // This phase now handles the response to the initial question
                    // User just responded to the initial welcome+question, now transition to the next logical step.
                    // No new question is asked by the bot in this prompt, as the previous phase already asked the first question.
                    // The updatePhase function will handle the transition to Fase 1.2
                    prompt += `
                    El usuario acaba de responder a la pregunta inicial: "${userMessage}".
                    Analiza su respuesta.
                    Si la respuesta es muy breve, general, o parece que el usuario necesita m√°s ideas (ej. 'no s√©', 'muchas cosas', 'lo normal'), entonces **brinda los ejemplos detallados**: "Por ejemplo, editar videos, reparar cosas, ayudar a otros, escribir historias, programar juegos, cuidar plantas, dise√±ar ropa, investigar temas de ciencia, practicar deportes, organizar eventos o aprender idiomas, entre muchas otras." Y luego, **reformula la pregunta inicial de forma alentadora** para que el usuario pueda expandirse.
                    Si la respuesta es clara y espec√≠fica, entonces **contin√∫a el di√°logo en forma natural** y pasa a la siguiente pregunta de la secuencia (Paso 1.2).
                    `;
                    userProfile.actividades_ocio = userMessage; // Store response from previous phase
                    break;
                case 'Fase 1.2':
                    prompt += `
                    **Paso 1.2:** ${EMOJI_GUIDE_QUESTION} **¬øQu√© materias o temas del colegio disfrut√°s m√°s y por qu√©? ¬øY alguna que te guste menos? Contame un poco por qu√©.**
                    `;
                    userProfile.materias_gusto = userMessage;
                    break;
                case 'Fase 1.3':
                    prompt += `
                    **Paso 1.3:** ${EMOJI_GUIDE_QUESTION} **Si pudieras elegir un proyecto o causa en la que trabajar durante un a√±o, ¬øcu√°l ser√≠a y qu√© rol te gustar√≠a tener?**
                    `;
                    userProfile.proyecto_causa = userMessage;
                    break;
                case 'Fase 1.4':
                    prompt += `
                    **Paso 1.4:** ${EMOJI_GUIDE_QUESTION} **¬øPrefer√≠s trabajar en contacto con personas, con ideas, con tecnolog√≠as, con la naturaleza o con objetos f√≠sicos?**
                    `;
                    userProfile.preferencia_contacto = userMessage;
                    break;
                case 'Fase 2.1':
                    prompt += `
                    **Paso 2.1:** ${EMOJI_GUIDE_QUESTION} **¬øTe imagin√°s trabajando en un mismo lugar todos los d√≠as o prefer√≠s cambiar de espacios, moverte, viajar?**
                    `;
                    userProfile.estilo_lugar_trabajo = userMessage;
                    break;
                case 'Fase 2.2':
                    prompt += `
                    **Paso 2.2:** ${EMOJI_GUIDE_QUESTION} **¬øQu√© te gustar√≠a que las personas valoren de tu trabajo en el futuro?**
                    `;
                    userProfile.valores_trabajo = userMessage;
                    break;
                case 'Fase 2.3':
                    prompt += `
                    **Paso 2.3:** ${EMOJI_GUIDE_QUESTION} **¬øYa conoc√©s algunas carreras, tecnicaturas u oficios que te llamen la atenci√≥n? ¬øQuer√©s que te comparta informaci√≥n sobre ellas o sobre c√≥mo seguir explorando?**
                    `;
                    userProfile.carreras_preexistentes = userMessage;
                    break;
                case 'Fase 3.1': // This phase is now the "Resumen General"
                    prompt += `
                    **Paso 3.1:** ${EMOJI_SUMMARY_CONFIRMATION} Resumen General. Pide validaci√≥n final del perfil completo.
                    Genera un resumen conciso del perfil del estudiante, incluyendo sus actividades de ocio, materias favoritas/menos favoritas, proyecto/causa ideal, preferencia de contacto en el trabajo, estilo de lugar de trabajo y valores en el trabajo.
                    **Pregunta:** **¬øEs correcto este resumen de tu perfil?**
                    **A√±ade al final de tu respuesta el marcador oculto: ---CONFIRMAR_SI_NO---**
                    `;
                    userProfile.confirmacion_perfil = userMessage; // Store confirmation
                    break;
                case 'Fase 3.2': // This phase now handles the logistical filter, after profile confirmation
                    prompt += `
                    **Paso 3.2:** ${EMOJI_GUIDE_QUESTION} Para afinar las opciones, **¬øprefer√≠s quedarte en La Pampa, te interesa estudiar a distancia (online), o estar√≠as dispuesto/a a mudarte a otra provincia?**
                    `;
                    userProfile.preferencias_logisticas = userMessage; // Store logistical preference
                    break;
                case 'Fase 4.1': // This phase suggests areas based on the profile and logistical preference
                    prompt += `
                    **Paso 4.1:** ${EMOJI_IDEA_SUGGESTION} Sugiere de 2 a 3 √Åreas de Conocimiento y pregunta cu√°l explorar.
                    Basado en el perfil completo del estudiante y su preferencia log√≠stica (${userProfile.preferencias_logisticas}), sugiere 2 o 3 √°reas de conocimiento generales (ej. Ciencias de la Salud, Tecnolog√≠a, Artes y Dise√±o, Ciencias Sociales, Educaci√≥n, Ciencias Agrarias).
                    **Aseg√∫rate de que estas √°reas est√©n formateadas como una lista con vi√±etas (ej. * √Årea 1).**
                    **Pregunta al estudiante cu√°l de esas √°reas le gustar√≠a explorar primero.**
                    **IMPORTANTE:** Guarda las √°reas sugeridas en la variable 'suggestedAreas' para referencia futura.
                    `;
                    userProfile.preferencias_logisticas = userMessage; // Store logistical preference
                    break;
                case 'Fase 4.2': // This phase is triggered when user selects an area
                    prompt += `
                    **Paso 4.2:** ${EMOJI_ACADEMIC_INFO} Proporciona un listado de carreras espec√≠ficas del √°rea elegida.
                    El usuario ha elegido el √°rea: "${userMessage}".
                    Ahora, lista de 3 a 5 carreras espec√≠ficas dentro de esa √°rea, siguiendo el orden de prioridad de conocimiento (La Pampa > Nacional Online > Otras Provincias si aplica).
                    Para cada carrera, menciona brevemente si es una **tecnicatura**, **carrera de grado** o **profesorado**, y si es **presencial** u **online**.
                    **Aseg√∫rate de que la respuesta est√© estructurada con vi√±etas para cada instituci√≥n, y vi√±etas anidadas para las carreras debajo de cada instituci√≥n, incluyendo un enlace al sitio oficial si es posible. Ejemplo:**
                    **Ejemplo de formato:**
                    * Universidad Nacional de La Pampa (UNLPam):
                        * Ingenier√≠a en Sistemas: (descripci√≥n breve) [Enlace al sitio oficial]
                        * Profesorado en Computaci√≥n: (descripci√≥n breve) [Enlace al sitio oficial]
                    * Instituto Tecnol√≥gico de Educaci√≥n Superior de La Pampa (ITES):
                        * Tecnicatura Superior en Desarrollo de Software: (descripci√≥n breve) [Enlace al sitio oficial]
                        * Tecnicatura Superior en Redes Inform√°ticas: (descripci√≥n breve) [Enlace al sitio oficial]
                    **Si el usuario no eligi√≥ una de las √°reas sugeridas, p√≠dele que elija una de las opciones o que aclare su inter√©s.**
                    `;
                    selectedArea = userMessage; // Store the selected area
                    break;
                case 'Fase 4.3': // This phase is now the reflection on options
                    prompt += `
                    **Paso 4.3:** ${EMOJI_REFLECTION} Plantea una pregunta abierta para fomentar la reflexi√≥n sobre las opciones.
                    Ejemplo: "De estas carreras que te mencion√©, ¬øhay alguna que te genere m√°s curiosidad o que te llame la atenci√≥n? ¬øPor qu√©?"
                    **Aseg√∫rate de que esta pregunta est√© en negrita.**
                    `;
                    userProfile.carreras_sugeridas_area = userMessage; // Store the list of careers suggested by the bot
                    break;
                case 'Fase 4.4': // This phase is now offering to deepen
                    prompt += `
                    **Paso 4.4:** Ofrece profundizar en la carrera que m√°s le interes√≥ (materias, duraci√≥n, etc.).
                    El usuario ha expresado inter√©s en: "${userMessage}".
                    **Pregunta si quiere que profundices en esa carrera (ej. materias principales, duraci√≥n aproximada, perfil del egresado, d√≥nde se estudia).**
                    `;
                    userProfile.carrera_interes_fase4 = userMessage;
                    break;
                case 'Fase 5.1': // This phase is now asking to explore more or close
                    prompt += `
                    **Paso 5.1:** Pregunta si quiere explorar otra de las √°reas sugeridas o si tiene alguna otra duda.
                    Recuerda las √°reas sugeridas previamente: ${JSON.stringify(suggestedAreas)}.
                    **Aseg√∫rate de que esta pregunta est√© en negrita.**
                    `;
                    userProfile.profundizacion_carrera = userMessage;
                    break;
                case 'Fase 5.2': // This phase is now the final summary and next steps
                    prompt += `
                    **Paso 5.2:** Para cerrar, ofrece un resumen de las conclusiones y sugiere los pr√≥ximos pasos pr√°cticos (visitar sitios web, buscar testimonios, etc.).
                    Importante: Este asistente fue dise√±ado con Inteligencia Artificial para acompa√±arte en la exploraci√≥n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaci√≥n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexi√≥n, di√°logo y consulta humana.
                    Si el usuario quiere explorar otra √°rea, vuelve a la Fase 4.2 (anteriormente 4.3) con la nueva √°rea. Si tiene otra duda, responde la duda. Si quiere cerrar, procede con el resumen y los pr√≥ximos pasos.
                    `;
                    userProfile.exploracion_adicional = userMessage;
                    break;
                case 'Fase 5.3': // This phase is now the disclaimer
                    prompt += `
                    **Paso 5.3:** ${EMOJI_PROFESSIONAL_CLARIFICATION} Aclaraci√≥n Final Importante.
                    Incluye siempre la siguiente aclaraci√≥n, presentada de forma destacada:
                    "**Aclaraci√≥n Importante:** Record√° que soy una herramienta de inteligencia artificial dise√±ada para darte ideas y servir como un primer paso en tu exploraci√≥n. Este di√°logo es un excelente punto de partida, pero no sustituye el valioso criterio, la escucha y el acompa√±amiento personalizado de un profesional de la orientaci√≥n vocacional. Te animo a conversar sobre estas ideas con un psic√≥logo/a o psicopedagogo/a de tu confianza para tomar la decisi√≥n final m√°s informada."
                    Luego, procede al Paso 5.4.
                    `;
                    userProfile.cierre_confirmado = userMessage;
                    break;
                case 'Fase 5.4': // This phase is now the reset option
                    prompt += `
                    **Paso 5.4:** ${EMOJI_RESET} Ofrece la opci√≥n de reseteo. Presenta la instrucci√≥n de forma clara, como un enlace de texto.
                    Texto: "Si en alg√∫n momento quer√©s volver a explorar todo desde cero con otras ideas, pod√©s hacerlo. Para eso, simplemente escrib√≠ la frase **empezar de nuevo**."
                    Luego, procede al Paso 5.5.
                    `;
                    break;
                case 'Fase 5.5': // This phase is now the farewell
                    prompt += `
                    **Paso 5.5:** Ahora s√≠, desp√≠dete con un mensaje alentador y el emoji ${EMOJI_WELCOME}.
                    Ejemplo: "¬°Fue un gusto conversar con vos! Te deseo mucho √©xito en tu b√∫squeda y en el camino que elijas. ¬°Hasta la pr√≥xima! üëã"
                    `;
                    break;
                case 'Fase 5.6':
                    // End of conversation, or user might restart
                    // No phase change, waiting for reset command
                    break;
                default:
                    console.warn("Unhandled phase transition:", current);
                    break;
            }

            // Add previous conversation history to the prompt for context
            let chatHistory = [];
            conversationHistory.forEach(msg => {
                chatHistory.push({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
            });
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            try {
                // Aqu√≠ el payload se construye para enviar el prompt y el historial por separado
                const payload = { 
                    userPrompt: prompt, // El prompt principal
                    chatHistory: chatHistory // El historial de conversaci√≥n
                };
                
                const apiUrl = '/api/chat'; // Apuntamos a nuestra funci√≥n serverless

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    let botResponse = result.candidates[0].content.parts[0].text;

                    // Check for the hidden marker to show confirmation buttons
                    if (botResponse.includes('---CONFIRMAR_SI_NO---')) {
                        botResponse = botResponse.replace('---CONFIRMAR_SI_NO---', '').trim(); // Remove marker
                        setTimeout(() => showConfirmationButtons(true), 300); // Show buttons with a slight delay
                    } else {
                        showConfirmationButtons(false); // Ensure buttons are hidden if not a confirmation
                    }

                    return botResponse; // Return the actual response text on success
                } else {
                    const errorMessageText = result.error ? `Error del servidor: ${result.error.message || result.error}` : 'Respuesta inesperada de la IA.';
                    console.error("Error from serverless function or unexpected Gemini response:", result);
                    return null; // Indicate failure
                }
            } catch (error) {
                console.error("Error calling serverless function:", error);
                return null; // Indicate failure
            } finally {
                // El estado de carga se gestiona en startInitialChat o sendMessage
            }
        };

        // Function to handle the initial chat startup with retries
        const startInitialChat = async () => {
            const isLocalOrCanvas = window.location.protocol === 'file:' || window.location.protocol === 'blob:';
            if (isLocalOrCanvas) {
                displayMessage("Disculp√°, la funcionalidad de IA requiere que la aplicaci√≥n est√© desplegada en un servidor (como Vercel) para funcionar. Por favor, despleg√° la aplicaci√≥n y asegurate de que la clave API est√© configurada en Vercel.", 'bot');
                sendButton.disabled = false;
                loadingIndicator.classList.remove('active');
                return;
            }

            sendButton.disabled = true; // Disable button during initial load
            loadingIndicator.classList.add('active'); // Show loading indicator

            let finalBotResponse = null;
            for (let i = 0; i <= MAX_INITIAL_RETRIES; i++) {
                try {
                    // La llamada inicial no tiene userMessage, pero necesita el prompt de sistema
                    // getBotResponse construir√° el prompt de sistema basado en currentPhase
                    const responseText = await getBotResponse(''); 
                    if (responseText) {
                        finalBotResponse = responseText;
                        break; // Exit loop if successful
                    }
                } catch (e) {
                    // getBotResponse already logs errors, no need to re-log here
                }

                if (!finalBotResponse && i < MAX_INITIAL_RETRIES) {
                    console.log(`Reintentando la llamada inicial (${i + 1}/${MAX_INITIAL_RETRIES})...`);
                    await delay(RETRY_DELAY_MS);
                }
            }

            if (finalBotResponse) {
                displayMessage(finalBotResponse, 'bot');
                conversationHistory.push({ text: finalBotResponse, sender: 'bot' });
                updatePhase(currentPhase, '', finalBotResponse); 
            } else {
                displayMessage("Disculp√°, no pude generar una respuesta. Hubo un problema de conexi√≥n. Por favor, verific√° tu conexi√≥n a internet.", 'bot');
            }

            sendButton.disabled = false;
            loadingIndicator.classList.remove('active');
        };


        // Event Listeners
        sendButton.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        yesButton.addEventListener('click', () => sendMessage('S√≠'));
        noButton.addEventListener('click', () => sendMessage('No'));


        // Initial setup on window load
        window.onload = () => {
            // Hide splash screen and show chat content after a short delay
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                chatContent.classList.add('visible');
                startInitialChat();
            }, 4000); // Display splash screen for 4 seconds
        };
    </script>
</body>
</html>
