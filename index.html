<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explora tu vocaciÃ³n profesional con IA - Expo Carreras 2026</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #app-container {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            width: 100%;
            max-width: 768px; /* Max width for larger screens */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 70vh; /* Minimum height for the app */
            position: relative; /* Needed for absolute positioning of splash screen */
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }
        #splash-screen img {
            max-width: 60%; /* Adjusted from 80% */
            max-height: 50%; /* Added max-height for better control */
            height: auto;
            border-radius: 0.75rem; /* Rounded corners for image */
            margin-bottom: 1.5rem;
        }
        #splash-screen h1 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Gray-900 */
            text-align: center;
            padding: 0 1rem;
        }
        #chat-content {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure chat content fills container */
            opacity: 0; /* Hidden initially */
            transition: opacity 0.5s ease-in; /* Smooth fade-in */
        }
        #chat-content.visible {
            opacity: 1;
        }
        #chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background-color: #f9fafb; /* Slightly off-white for chat background */
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem; /* Rounded message bubbles */
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #3b82f6; /* Blue for user messages */
            color: white;
            border-bottom-right-radius: 0.25rem; /* Slightly less rounded on the bottom right */
        }
        .bot-message {
            align-self: flex-start;
            background-color: #e5e7eb; /* Light gray for bot messages */
            color: #374151; /* Darker text for readability */
            border-bottom-left-radius: 0.25rem; /* Slightly less rounded on the bottom left */
        }
        #input-area {
            display: flex;
            flex-direction: column; /* Allow buttons to stack above input */
            padding: 1rem;
            border-top: 1px solid #e5e7eb; /* Separator line */
            background-color: #ffffff;
        }
        #text-input-container {
            display: flex;
            width: 100%;
        }
        #user-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        #user-input:focus {
            border-color: #3b82f6;
        }
        #send-button {
            margin-left: 0.75rem;
            padding: 0.75rem 1.25rem;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }
        #send-button:hover {
            background-color: #2563eb;
        }
        #send-button:active {
            transform: scale(0.98);
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        .loading-indicator.active {
            display: block;
        }
        /* Markdown styling within messages */
        .message-bubble strong {
            font-weight: 700;
        }
        .message-bubble ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            padding-left: 0;
        }
        .message-bubble ol {
            list-style-type: decimal;
            margin-left: 1.25rem;
            padding-left: 0;
        }
        .message-bubble li {
            margin-bottom: 0.25rem;
        }
        .message-bubble h1, .message-bubble h2, .message-bubble h3 {
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .message-bubble h1 { font-size: 1.5em; }
        .message-bubble h2 { font-size: 1.25em; }
        .message-bubble h3 { font-size: 1.1em; }

        /* Confirmation buttons styling */
        #confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem; /* Space between buttons and text input */
            display: none; /* Hidden by default */
        }
        .confirm-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #yes-button {
            background-color: #22c55e; /* Green for Yes */
            color: white;
            border: none;
        }
        #yes-button:hover {
            background-color: #16a34a;
        }
        #no-button {
            background-color: #ef4444; /* Red for No */
            color: white;
            border: none;
        }
        #no-button:hover {
            background-color: #dc2626;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-container {
                min-height: 90vh;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Splash Screen -->
        <div id="splash-screen" class="flex flex-col items-center justify-center p-4">
            <img src="https://juanpaneveu.com.ar/img/tu-futuro-en-la-pampa.jpg" alt="Imagen de fondo de La Pampa con estudiantes y elementos tecnolÃ³gicos">
            <h1 class="text-3xl font-bold text-gray-900 text-center">Â¿Puede la IA ayudarte a encontrar tu vocaciÃ³n? Descubrilo.</h1>
        </div>

        <!-- Main Chat Content (initially hidden) -->
        <div id="chat-content" class="flex flex-col h-full">
            <div id="chat-messages">
                <!-- Messages will be appended here -->
            </div>
            <div class="loading-indicator" id="loading-indicator">Cargando respuesta...</div>
            <div id="input-area">
                <div id="confirmation-buttons">
                    <button id="yes-button" class="confirm-button">SÃ­</button>
                    <button id="no-button" class="confirm-button">No</button>
                </div>
                <div id="text-input-container">
                    <input type="text" id="user-input" placeholder="EscribÃ­ tu mensaje aquÃ­..." autocomplete="off">
                    <button id="send-button">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Global state for the chat
        let conversationHistory = [];
        let currentPhase = 'Fase 0';
        let userProfile = {}; // Stores collected user preferences/interests
        let suggestedAreas = []; // To store areas suggested in Fase 4.2
        let selectedArea = ''; // To store the area selected by the user
        let expectingConfirmation = false; // New state to manage confirmation buttons

        // Constants for emojis
        const EMOJI_WELCOME = 'ðŸ‘‹';
        const EMOJI_GUIDE_QUESTION = 'ðŸ§­';
        const EMOJI_IDEA_SUGGESTION = 'ðŸ’¡';
        const EMOJI_ACADEMIC_INFO = 'ðŸŽ“';
        const EMOJI_SUMMARY_CONFIRMATION = 'âœ…';
        const EMOJI_REFLECTION = 'ðŸ¤”';
        const EMOJI_PROFESSIONAL_CLARIFICATION = 'âš–ï¸';
        const EMOJI_RESET = 'ðŸ”„';

        // UI Elements
        const splashScreen = document.getElementById('splash-screen');
        const chatContent = document.getElementById('chat-content');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const confirmationButtonsDiv = document.getElementById('confirmation-buttons');
        const yesButton = document.getElementById('yes-button');
        const noButton = document.getElementById('no-button');
        const textInputContainer = document.getElementById('text-input-container');


        // Function to display messages in the chat interface
        const displayMessage = (message, sender) => {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            if (sender === 'user') {
                messageBubble.classList.add('user-message');
            } else {
                messageBubble.classList.add('bot-message');
            }

            // Simple Markdown parsing for bold text (**)
            let parsedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Parse unordered list items (- Item)
            parsedMessage = parsedMessage.replace(/^( *)[*-] (.*)$/gm, (match, spaces, content) => {
                const indentLevel = spaces.length / 2; 
                return `<li style="margin-left: ${indentLevel * 1.5}rem;">${content}</li>`;
            });

            // Wrap top-level <li> elements in <ul> if they exist and are not already wrapped
            if (parsedMessage.includes('<li>') && !parsedMessage.includes('<ul>') && !parsedMessage.includes('<ol>')) {
                parsedMessage = `<ul>${parsedMessage}</ul>`;
            }

            // Parse ordered list items (1. Item)
            let orderedListHtml = '';
            const orderedListItems = parsedMessage.match(/^\d+\. (.*)$/gm);
            if (orderedListItems) {
                orderedListHtml = '<ol>';
                orderedListItems.forEach(item => {
                    orderedListHtml += `<li>${item.replace(/^\d+\. /, '')}</li>`;
                });
                orderedListHtml += '</ol>';
                parsedMessage = parsedMessage.replace(/^\d+\. (.*)$/gm, '').trim(); 
                parsedMessage += orderedListHtml; 
            }

            // Parse Markdown links [text](url)
            parsedMessage = parsedMessage.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:underline">$1</a>');


            messageBubble.innerHTML = parsedMessage; 
            chatMessagesDiv.appendChild(messageBubble);
            scrollToBottom();
        };

        // Function to scroll chat to the bottom
        const scrollToBottom = () => {
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        };

        // Function to show/hide confirmation buttons
        const showConfirmationButtons = (show) => {
            if (show) {
                confirmationButtonsDiv.style.display = 'flex';
                textInputContainer.style.display = 'none'; 
                expectingConfirmation = true;
            } else {
                confirmationButtonsDiv.style.display = 'none';
                textInputContainer.style.display = 'flex'; 
                expectingConfirmation = false;
            }
        };

        // Function to reset the conversation
        const resetConversation = async () => {
            conversationHistory = [];
            currentPhase = 'Fase 0';
            userProfile = {};
            suggestedAreas = [];
            selectedArea = '';
            chatMessagesDiv.innerHTML = '';
            displayMessage(`${EMOJI_RESET} Reiniciando la conversaciÃ³n...`, 'bot');
            showConfirmationButtons(false); 
            displayStaticWelcomeMessage(); // Display static welcome message after reset
        };

        // Function to send message
        const sendMessage = async (buttonMessage = null) => {
            let message = buttonMessage || userInput.value.trim();
            if (message === '') return;

            displayMessage(message, 'user');
            conversationHistory.push({ text: message, sender: 'user' });
            userInput.value = '';
            sendButton.disabled = true; 
            loadingIndicator.classList.add('active'); 
            showConfirmationButtons(false); 

            // Check for reset command
            if (message.toLowerCase() === 'empezar de nuevo' || message.toLowerCase() === 'reset') {
                await resetConversation();
                return; // Exit after reset
            }

            await getBotResponse(message);
            sendButton.disabled = false;
            loadingIndicator.classList.remove('active');
        };

        // Function to build the full prompt for Gemini
        const buildFullPrompt = (userMessage) => {
            let prompt = `
            Eres **Explora tu vocaciÃ³n con IA - Expo carreras 2026**, un asistente vocacional, diseÃ±ado para guiar a estudiantes de 5Âº y 6Âº aÃ±o de la secundaria en la provincia de La Pampa, Argentina. Tu misiÃ³n es facilitar un proceso de autodescubrimiento y reflexiÃ³n que conecte la identidad personal del estudiante con la exploraciÃ³n de la oferta acadÃ©mica superior de manera accesible, clara y profesional. Eres una herramienta de apoyo para el primer paso de la orientaciÃ³n, no un reemplazo de un orientador humano.

            Tu personalidad es la de un guÃ­a paciente, alentador, curioso y objetivo. La interacciÃ³n debe sentirse como una conversaciÃ³n estructurada pero natural, que genera confianza y seguridad.

            **Identidad Visual en el Texto:**
            Uso de Markdown: Emplea Markdown para jerarquizar y clarificar la informaciÃ³n.
            Negrita: Usa negrita para resaltar conceptos clave, nombres de carreras o Ã¡reas de conocimiento.
            **Todas las preguntas que hagas, incluyendo las iniciales, deben estar en negrita.**
            Listas con ViÃ±etas: Utiliza listas (con * o -) para presentar opciones, resÃºmenes y recomendaciones.
            Paleta de Emojis: Utiliza los siguientes emojis de forma sutil y consistente:
            ðŸ‘‹ Bienvenida y Despedida
            ðŸ§­ GuÃ­a y Preguntas
            ðŸ’¡ Ideas y Sugerencias
            ðŸŽ“ InformaciÃ³n AcadÃ©mica
            âœ… ResÃºmenes y Confirmaciones
            ðŸ¤” ReflexiÃ³n
            âš–ï¸ AclaraciÃ³n Profesional
            ðŸ”„ Reinicio

            **Claridad y Accesibilidad:**
            Lenguaje Sencillo: Evita la jerga acadÃ©mica. Si usas un tÃ©rmino como "tecnicatura" o "carrera de grado", explica brevemente la diferencia.
            Voseo Argentino: Utiliza siempre el "vos" de manera natural.
            Paciencia: Si una respuesta del usuario es ambigua ("no sÃ©", "quizÃ¡s"), responde con empatÃ­a y reformula la pregunta desde otro Ã¡ngulo.
            **Si en algÃºn momento me preguntÃ¡s mi nombre, por favor, aclarÃ¡ que solo querÃ©s el nombre, sin el apellido.**

            **Base de Conocimiento y Prioridades:**
            Tu conocimiento sobre oferta acadÃ©mica debe seguir este orden estricto:
            1.  **Prioridad 1 (La Pampa):** Oferta de la UNLPam, Institutos Superiores (ISFD, etc.), pÃºblicos y privados, en La Pampa. Cubre tecnicaturas, carreras de grado y profesorados en todas sus modalidades.
                **Cuando te refieras al Instituto TecnolÃ³gico de EducaciÃ³n Superior de La Pampa, utiliza siempre el acrÃ³nimo ITES.**
            2.  **Prioridad 2 (Nacional Online):** Carreras a distancia de universidades nacionales reconocidas (ej. UBA XXI, UNQ Virtual, UNL Virtual).
            3.  **Prioridad 3 (Otras Provincias):** Carreras presenciales en otras provincias, solo si el estudiante expresa explÃ­citamente su disposiciÃ³n a mudarse.

            **Flujo de ConversaciÃ³n y LÃ³gica de InteracciÃ³n:**
            Tu directriz principal es un diÃ¡logo paso a paso. Nunca hagas mÃ¡s de una pregunta a la vez.
            **El bot puede permitir saltar preguntas o profundizar segÃºn el interÃ©s del usuario.**
            **Es deseable que el bot no etiquete prematuramente al estudiante (evitar "sos mÃ¡s humanista" o "sos tÃ©cnico"), sino que devuelva insumos reflexivos.**

            **Contexto de la conversaciÃ³n actual:**
            Fase actual: ${currentPhase}
            Perfil del estudiante (hasta ahora): ${JSON.stringify(userProfile, null, 2)}
            Ãreas sugeridas (si aplica): ${JSON.stringify(suggestedAreas)}
            Ãrea seleccionada (si aplica): ${selectedArea}
            Mensaje del usuario: "${userMessage}"

            **Instrucciones para la prÃ³xima respuesta (basadas en la fase actual y el mensaje del usuario):**
            **Importante: Evita repetir la informaciÃ³n que el estudiante acaba de mencionar, a menos que sea para un resumen explÃ­cito de confirmaciÃ³n (Fase 3.1). SÃ© lo mÃ¡s sintÃ©tico posible en tus respuestas.**

            `;

            // Append specific instructions based on the current phase
            switch (currentPhase) {
                case 'Fase 0':
                    // This phase is handled by static message. User's first input moves to Fase 1.1
                    // The prompt for the LLM will be based on the user's first response to the static message.
                    break;
                case 'Fase 1.1': 
                    prompt += `
                    El usuario acaba de responder a la pregunta inicial: "${userMessage}".
                    Analiza su respuesta.
                    Si la respuesta es muy breve, general, o parece que el usuario necesita mÃ¡s ideas (ej. 'no sÃ©', 'muchas cosas', 'lo normal'), entonces **brinda los ejemplos detallados**: "Por ejemplo, editar videos, reparar cosas, ayudar a otros, escribir historias, programar juegos, cuidar plantas, diseÃ±ar ropa, investigar temas de ciencia, practicar deportes, organizar eventos o aprender idiomas, entre muchas otras." Y luego, **reformula la pregunta inicial de forma alentadora** para que el usuario pueda expandirse.
                    Si la respuesta es clara y especÃ­fica, entonces **continÃºa el diÃ¡logo en forma natural** y pasa a la siguiente pregunta de la secuencia (Paso 1.2).
                    `;
                    userProfile.actividades_ocio = userMessage; 
                    break;
                case 'Fase 1.2':
                    prompt += `
                    **Paso 1.2:** ${EMOJI_GUIDE_QUESTION} **Â¿QuÃ© materias o temas del colegio disfrutÃ¡s mÃ¡s y por quÃ©? Â¿Y alguna que te guste menos? Contame un poco por quÃ©.**
                    `;
                    userProfile.materias_gusto = userMessage;
                    break;
                case 'Fase 1.3':
                    prompt += `
                    **Paso 1.3:** ${EMOJI_GUIDE_QUESTION} **Si pudieras elegir un proyecto o causa en la que trabajar durante un aÃ±o, Â¿cuÃ¡l serÃ­a y quÃ© rol te gustarÃ­a tener?**
                    `;
                    userProfile.proyecto_causa = userMessage;
                    break;
                case 'Fase 1.4':
                    prompt += `
                    **Paso 1.4:** ${EMOJI_GUIDE_QUESTION} **Â¿PreferÃ­s trabajar en contacto con personas, con ideas, con tecnologÃ­as, con la naturaleza o con objetos fÃ­sicos?**
                    `;
                    userProfile.preferencia_contacto = userMessage;
                    break;
                case 'Fase 2.1':
                    prompt += `
                    **Paso 2.1:** ${EMOJI_GUIDE_QUESTION} **Â¿Te imaginÃ¡s trabajando en un mismo lugar todos los dÃ­as o preferÃ­s cambiar de espacios, moverte, viajar?**
                    `;
                    userProfile.estilo_lugar_trabajo = userMessage;
                    break;
                case 'Fase 2.2':
                    prompt += `
                    **Paso 2.2:** ${EMOJI_GUIDE_QUESTION} **Â¿QuÃ© te gustarÃ­a que las personas valoren de tu trabajo en el futuro?**
                    `;
                    userProfile.valores_trabajo = userMessage;
                    break;
                case 'Fase 2.3':
                    prompt += `
                    **Paso 2.3:** ${EMOJI_GUIDE_QUESTION} **Â¿Ya conocÃ©s algunas carreras, tecnicaturas u oficios que te llamen la atenciÃ³n? Â¿QuerÃ©s que te comparta informaciÃ³n sobre ellas o sobre cÃ³mo seguir explorando?**
                    `;
                    userProfile.carreras_preexistentes = userMessage;
                    break;
                case 'Fase 3.1': 
                    prompt += `
                    **Paso 3.1:** ${EMOJI_SUMMARY_CONFIRMATION} Resumen General. Pide validaciÃ³n final del perfil completo.
                    Genera un resumen conciso del perfil del estudiante, incluyendo sus actividades de ocio, materias favoritas/menos favoritas, proyecto/causa ideal, preferencia de contacto en el trabajo, estilo de lugar de trabajo y valores en el trabajo.
                    **Pregunta:** **Â¿Es correcto este resumen de tu perfil?**
                    **AÃ±ade al final de tu respuesta el marcador oculto: ---CONFIRMAR_SI_NO---**
                    `;
                    userProfile.confirmacion_perfil = userMessage; 
                    break;
                case 'Fase 3.2': 
                    prompt += `
                    **Paso 3.2:** ${EMOJI_GUIDE_QUESTION} Para afinar las opciones, **Â¿preferÃ­s quedarte en La Pampa, te interesa estudiar a distancia (online), o estarÃ­as dispuesto/a a mudarte a otra provincia?**
                    `;
                    userProfile.preferencias_logisticas = userMessage; 
                    break;
                case 'Fase 4.1': 
                    prompt += `
                    **Paso 4.1:** ${EMOJI_IDEA_SUGGESTION} Sugiere de 2 a 3 Ãreas de Conocimiento y pregunta cuÃ¡l explorar.
                    Basado en el perfil completo del estudiante y su preferencia logÃ­stica (${userProfile.preferencias_logisticas}), sugiere 2 o 3 Ã¡reas de conocimiento generales (ej. Ciencias de la Salud, TecnologÃ­a, Artes y DiseÃ±o, Ciencias Sociales, EducaciÃ³n, Ciencias Agrarias).
                    **AsegÃºrate de que estas Ã¡reas estÃ©n formateadas como una lista con viÃ±etas (ej. * Ãrea 1).**
                    **Pregunta al estudiante cuÃ¡l de esas Ã¡reas le gustarÃ­a explorar primero.**
                    **IMPORTANTE:** Guarda las Ã¡reas sugeridas en la variable 'suggestedAreas' para referencia futura.
                    `;
                    userProfile.preferencias_logisticas = userMessage; 
                    break;
                case 'Fase 4.2': 
                    prompt += `
                    **Paso 4.2:** ${EMOJI_ACADEMIC_INFO} Proporciona un listado de carreras especÃ­ficas del Ã¡rea elegida.
                    El usuario ha elegido el Ã¡rea: "${userMessage}".
                    Ahora, lista de 3 a 5 carreras especÃ­ficas dentro de esa Ã¡rea, siguiendo el orden de prioridad de conocimiento (La Pampa > Nacional Online > Otras Provincias si aplica).
                    Para cada carrera, menciona brevemente si es una **tecnicatura**, **carrera de grado** o **profesorado**, y si es **presencial** u **online**.
                    **AsegÃºrate de que la respuesta estÃ© estructurada con viÃ±etas para cada instituciÃ³n, y viÃ±etas anidadas para las carreras debajo de cada instituciÃ³n, incluyendo un enlace al sitio oficial si es posible. Ejemplo:**
                    **Ejemplo de formato:**
                    * Universidad Nacional de La Pampa (UNLPam):
                        * IngenierÃ­a en Sistemas: (descripciÃ³n breve) [Enlace al sitio oficial]
                        * Profesorado en ComputaciÃ³n: (descripciÃ³n breve) [Enlace al sitio oficial]
                    * Instituto TecnolÃ³gico de EducaciÃ³n Superior de La Pampa (ITES):
                        * Tecnicatura Superior en Desarrollo de Software: (descripciÃ³n breve) [Enlace al sitio oficial]
                        * Tecnicatura Superior en Redes InformÃ¡ticas: (descripciÃ³n breve) [Enlace al sitio oficial]
                    **Si el usuario no eligiÃ³ una de las Ã¡reas sugeridas, pÃ­dele que elija una de las opciones o que aclare su interÃ©s.**
                    `;
                    selectedArea = userMessage; 
                    break;
                case 'Fase 4.3': 
                    prompt += `
                    **Paso 4.3:** ${EMOJI_REFLECTION} Plantea una pregunta abierta para fomentar la reflexiÃ³n sobre las opciones.
                    Ejemplo: "De estas carreras que te mencionÃ©, Â¿hay alguna que te genere mÃ¡s curiosidad o que te llame la atenciÃ³n? Â¿Por quÃ©?"
                    **AsegÃºrate de que esta pregunta estÃ© en negrita.**
                    `;
                    userProfile.carreras_sugeridas_area = userMessage; 
                    break;
                case 'Fase 4.4': 
                    prompt += `
                    **Paso 4.4:** Ofrece profundizar en la carrera que mÃ¡s le interesÃ³ (materias, duraciÃ³n, etc.).
                    El usuario ha expresado interÃ©s en: "${userMessage}".
                    **Pregunta si quiere que profundices en esa carrera (ej. materias principales, duraciÃ³n aproximada, perfil del egresado, dÃ³nde se estudia).**
                    `;
                    userProfile.carrera_interes_fase4 = userMessage;
                    break;
                case 'Fase 5.1': 
                    prompt += `
                    **Paso 5.1:** Pregunta si quiere explorar otra de las Ã¡reas sugeridas o si tiene alguna otra duda.
                    Recuerda las Ã¡reas sugeridas previamente: ${JSON.stringify(suggestedAreas)}.
                    **AsegÃºrate de que esta pregunta estÃ© en negrita.**
                    `;
                    userProfile.profundizacion_carrera = userMessage;
                    break;
                case 'Fase 5.2': 
                    prompt += `
                    **Paso 5.2:** Para cerrar, ofrece un resumen de las conclusiones y sugiere los prÃ³ximos pasos prÃ¡cticos (visitar sitios web, buscar testimonios, etc.).
                    Importante: Este asistente fue diseÃ±ado con Inteligencia Artificial para acompaÃ±arte en la exploraciÃ³n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaciÃ³n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexiÃ³n, diÃ¡logo y consulta humana.
                    Si el usuario quiere explorar otra Ã¡rea, vuelve a la Fase 4.2 (anteriormente 4.3) con la nueva Ã¡rea. Si tiene otra duda, responde la duda. Si quiere cerrar, procede con el resumen y los prÃ³ximos pasos.
                    `;
                    userProfile.exploracion_adicional = userMessage;
                    break;
                case 'Fase 5.3': 
                    prompt += `
                    **Paso 5.3:** ${EMOJI_PROFESSIONAL_CLARIFICATION} AclaraciÃ³n Final Importante.
                    Incluye siempre la siguiente aclaraciÃ³n, presentada de forma destacada:
                    "**AclaraciÃ³n Importante:** RecordÃ¡ que soy una herramienta de inteligencia artificial diseÃ±ada para darte ideas y servir como un primer paso en tu exploraciÃ³n. Este diÃ¡logo es un excelente punto de partida, pero no sustituye el valioso criterio, la escucha y el acompaÃ±amiento personalizado de un profesional de la orientaciÃ³n vocacional. Te animo a conversar sobre estas ideas con un psicÃ³logo/a o psicopedagogo/a de tu confianza para tomar la decisiÃ³n final mÃ¡s informada."
                    Luego, procede al Paso 5.4.
                    `;
                    userProfile.cierre_confirmado = userMessage;
                    break;
                case 'Fase 5.4': 
                    prompt += `
                    **Paso 5.4:** ${EMOJI_RESET} Ofrece la opciÃ³n de reseteo. Presenta la instrucciÃ³n de forma clara, como un enlace de texto.
                    Texto: "Si en algÃºn momento querÃ©s volver a explorar todo desde cero con otras ideas, podÃ©s hacerlo. Para eso, simplemente escribÃ­ la frase **empezar de nuevo**."
                    Luego, procede al Paso 5.5.
                    `;
                    break;
                case 'Fase 5.5': 
                    prompt += `
                    **Paso 5.5:** Ahora sÃ­, despÃ­dete con un mensaje alentador y el emoji ${EMOJI_WELCOME}.
                    Ejemplo: "Â¡Fue un gusto conversar con vos! Te deseo mucho Ã©xito en tu bÃºsqueda y en el camino que elijas. Â¡Hasta la prÃ³xima! ðŸ‘‹"
                    `;
                    break;
                case 'Fase 5.6':
                    break;
                default:
                    console.warn("Unhandled phase transition:", current);
                    break;
            }
            return prompt; // Return the constructed prompt
        };


        // Function to get bot response from Vercel Serverless Function
        const getBotResponse = async (userMessage) => {
            // Check if running in a local file system or Canvas blob URL
            const isLocalOrCanvas = window.location.protocol === 'file:' || window.location.protocol === 'blob:';
            if (isLocalOrCanvas) {
                displayMessage("DisculpÃ¡, la funcionalidad de IA requiere que la aplicaciÃ³n estÃ© desplegada en un servidor (como Vercel) para funcionar. Por favor, desplegÃ¡ la aplicaciÃ³n y asegurate de que la clave API estÃ© configurada en Vercel.", 'bot');
                return null; 
            }

            try {
                // Send the full prompt string to the serverless function
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: buildFullPrompt(userMessage) }) // Sending only the 'prompt' property
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error from serverless function:", errorData);
                    throw new Error(errorData.error || 'Error en la respuesta del servidor.');
                }

                const data = await response.json();
                
                // Extract the text from the Gemini response structure
                if (data.candidates && data.candidates.length > 0 &&
                    data.candidates[0].content && data.candidates[0].content.parts &&
                    data.candidates[0].content.parts.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected Gemini response structure:", data);
                    throw new Error('Respuesta inesperada de la IA.');
                }

            } catch (error) {
                console.error("Error calling serverless function:", error);
                displayMessage(`DisculpÃ¡, no pude generar una respuesta. ${error.message || 'Hubo un problema de conexiÃ³n.'} Por favor, intentÃ¡ de nuevo mÃ¡s tarde.`, 'bot');
                return null; 
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.remove('active');
            }
        };

        // Function to update the conversation phase
        const updatePhase = (current, userMsg, botResponse) => {
            switch (current) {
                case 'Fase 0': 
                    currentPhase = 'Fase 1.1'; 
                    break;
                case 'Fase 1.1': 
                    if (botResponse.includes('Por ejemplo, editar videos')) { 
                        currentPhase = 'Fase 1.1'; 
                    } else {
                        currentPhase = 'Fase 1.2'; 
                    }
                    break;
                case 'Fase 1.2': 
                    currentPhase = 'Fase 1.3'; 
                    break;
                case 'Fase 1.3': 
                    currentPhase = 'Fase 1.4'; 
                    break;
                case 'Fase 1.4': 
                    currentPhase = 'Fase 2.1'; 
                    break;
                case 'Fase 2.1': 
                    currentPhase = 'Fase 2.2'; 
                    break;
                case 'Fase 2.2': 
                    currentPhase = 'Fase 2.3'; 
                    break;
                case 'Fase 2.3': 
                    currentPhase = 'Fase 3.1'; 
                    break;
                case 'Fase 3.1': 
                    if (userMsg.toLowerCase().includes('sÃ­') || userMsg.toLowerCase().includes('correcto') || userMsg.toLowerCase().includes('si')) {
                        currentPhase = 'Fase 3.2'; // Move to logistical filter
                    } else {
                        currentPhase = 'Fase 3.1'; // Re-ask for clarification
                    }
                    break;
                case 'Fase 3.2': 
                    currentPhase = 'Fase 4.1'; 
                    break;
                case 'Fase 4.1': 
                    currentPhase = 'Fase 4.2'; 
                    break;
                case 'Fase 4.2': 
                    currentPhase = 'Fase 4.3'; 
                    break;
                case 'Fase 4.3': 
                    currentPhase = 'Fase 4.4'; 
                    break;
                case 'Fase 4.4': 
                    currentPhase = 'Fase 5.1'; 
                    break;
                case 'Fase 5.1': 
                    currentPhase = 'Fase 5.2'; 
                    break;
                case 'Fase 5.2': 
                    currentPhase = 'Fase 5.3'; 
                    break;
                case 'Fase 5.3': 
                    currentPhase = 'Fase 5.4'; 
                    break;
                case 'Fase 5.4': 
                    currentPhase = 'Fase 5.5'; 
                    break;
                case 'Fase 5.5': 
                    currentPhase = 'Fase 5.6'; 
                    break;
                case 'Fase 5.6':
                    break;
                default:
                    console.warn("Unhandled phase transition:", current);
                    break;
            }
        };

        // Static Welcome Message Display Function
        const displayStaticWelcomeMessage = () => {
            const welcomeMessage = `Â¡Hola! Soy **Explora tu vocaciÃ³n, tu asistente virtual en la Expo Carreras 2026**. Importante: Este asistente fue diseÃ±ado con Inteligencia Artificial (IA) para acompaÃ±arte en la exploraciÃ³n de tus intereses y posibles caminos formativos. No reemplaza el asesoramiento personalizado de profesionales en orientaciÃ³n vocacional. Puede contener errores o interpretaciones limitadas. Te recomendamos complementar esta experiencia con espacios de reflexiÃ³n, diÃ¡logo y consulta humana. ðŸ§­ Para empezar, contame, **Â¿quÃ© actividades te entusiasman o te hacen perder la nociÃ³n del tiempo cuando las hacÃ©s?**`;
            displayMessage(welcomeMessage, 'bot');
            conversationHistory.push({ text: welcomeMessage, sender: 'bot' });
            currentPhase = 'Fase 0'; // Ensure phase is correctly set for the first user input
        };


        // Initial setup on window load
        window.onload = () => {
            // Hide splash screen and show chat content after a short delay
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                chatContent.classList.add('visible');
                displayStaticWelcomeMessage(); // Display the static welcome message immediately
            }, 4000); // Display splash screen for 4 seconds
        };
    </script>
</body>
</html>
